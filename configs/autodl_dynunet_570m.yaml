# configs/autodl_dynunet_570m.yaml
# DynUNet 570M 配置（base_num_features=80），用于 32GB 5090

model:
  type: dynunet
  in_channels: 5              # 先沿用 5ch（raw + grad_xyz + LoG），后续可扩展到 7-9ch
  base_num_features: 80       # 约 570M 参数
  out_channels: 1
  deep_supervision: true
  # 可选：预训练权重路径（Kaggle / 本地）
  pretrained_checkpoint: ''   # 如: 'models/pretrained_dynunet_570m.pth'

data:
  train_dir: 'data/processed/train'
  val_dir: 'data/processed/val'
  patch_size: [128, 128, 128]
  spacing: [1.0, 1.0, 1.0]
  dataset_type: 'ink_aware'
  positive_ratio: 0.7
  min_ink_pixels: 100
  num_samples_per_epoch: 500
  cache_rate: 1.0
  channels: ['raw', 'grad', 'log']

training:
  batch_size: 1
  accumulation_steps: 16      # 模型更大，适当增加梯度累积
  epochs: 8                   # 先做快速验证
  learning_rate: 0.0003
  weight_decay: 0.00001
  num_workers: 4
  prefetch_factor: 2
  pin_memory: true
  save_frequency: 2
  checkpoint_dir: 'models/checkpoints_dynunet_570m'
  use_dynamic_loss: true
  warmup_epochs: 4
  loss_schedule: 'two_stage'

loss:
  type: vesuvius_composite
  dice_weight: 0.5
  bce_weight: 0.5
  surface_weight: 0.0
  topology_weight: 0.0
  centerline_weight: 0.0

optimizer:
  type: adamw
  betas: [0.9, 0.999]
  eps: 0.00000001

scheduler:
  type: cosine
  T_max: 8
  eta_min: 0.000001

augmentation:
  random_flip: true
  random_rotation: 15
  elastic_deformation: true
  elastic_alpha: [100, 200]
  elastic_sigma: [10, 20]
  intensity_shift: 0.1
  gaussian_noise: true
  noise_std: 0.05

postprocessing:
  enabled: true
  min_component_size: 800
  min_hole_size: 1000
  persistence_threshold: 0.0015
  multi_threshold: true
  thresholds: [0.3, 0.4, 0.5]

evaluation:
  use_vesuvius_metrics: true
  surface_dice_tau: 2.0
  spacing: [1.0, 1.0, 1.0]

logging:
  use_wandb: false
  project: 'vesuvius-dynunet-570m'
  log_frequency: 10

inference:
  patch_size: [128, 128, 128]
  overlap: 0.5
  batch_size: 1
  tta: true
  use_postprocessing: true
